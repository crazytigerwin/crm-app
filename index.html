<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midwest Natural Fiber CRM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f9;
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: #2d7a7a;
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            height: 80px;
            width: auto;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .logo-fallback {
            display: none;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
        }

        .logo-fallback .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #2d7a7a;
            line-height: 1.1;
        }

        .logo-fallback .logo-subtext {
            font-size: 10px;
            color: #666;
            letter-spacing: 1px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: #e07856;
            color: white;
        }

        .tab-btn.active {
            color: white;
            background: #2d7a7a;
            border-bottom: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid #2d7a7a;
        }

        .metric-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #2d7a7a;
        }

        button {
            background: #e07856;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }

        button:hover {
            background: #c85e3f;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            color: #333;
            background-color: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2d7a7a;
            box-shadow: 0 0 0 3px rgba(45, 122, 122, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2d7a7a;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        thead {
            background: #f5f5f5;
            font-weight: 600;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        tbody tr.clickable-row {
            cursor: pointer;
        }

        tbody tr.clickable-row:hover {
            background: #e8f4f4;
        }

        .opp-link {
            color: #2d7a7a;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }

        .opp-link:hover {
            text-decoration: underline;
        }

        .prob-0-33 {
            background: #fdd9d6;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .prob-34-66 {
            background: #fff8e1;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .prob-67-100 {
            background: #d4edda;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 13px;
        }

        .sku-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #2d7a7a;
        }

        .sku-section-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d7a7a;
            font-size: 14px;
        }

        .sku-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sku-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sku-checkbox input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .sku-checkbox label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            font-size: 13px;
        }

        .contact-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #2d7a7a;
            cursor: pointer;
        }

        .contact-item:hover {
            background: #f0f0f0;
        }

        .contact-name {
            font-weight: 600;
            color: #2d7a7a;
            margin-bottom: 5px;
        }

        .contact-info {
            font-size: 12px;
            color: #666;
        }

        .activity-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #2d7a7a;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .activity-type {
            display: inline-block;
            padding: 3px 8px;
            background: #e07856;
            color: white;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        .activity-date {
            font-size: 11px;
            color: #999;
        }

        .activity-desc {
            font-size: 12px;
            color: #333;
            line-height: 1.4;
        }

        .next-steps-label {
            font-size: 11px;
            font-weight: 600;
            color: #2d7a7a;
            margin-top: 8px;
        }

        .next-steps-text {
            font-size: 12px;
            color: #555;
            font-style: italic;
            background: #e8f4f4;
            padding: 6px 10px;
            border-radius: 4px;
            margin-top: 4px;
        }

        .detail-item {
            padding: 12px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #2d7a7a;
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: 600;
            color: #2d7a7a;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-value {
            color: #333;
            font-size: 13px;
        }

        .bant-section {
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 4px;
            border-left: 3px solid #2d7a7a;
        }

        .bant-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d7a7a;
        }

        .error {
            background: #fae7e7;
            color: #b81c1c;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .success {
            background: #e7f5e7;
            color: #1b6e0b;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .selected-skus {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .selected-skus-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2d7a7a;
        }

        .sku-tag {
            display: inline-block;
            background: #e07856;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 11px;
        }

        /* Pipeline Styles */
        .pipeline-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .pipeline-funnel {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .funnel-stage {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-left: 6px solid #2d7a7a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .funnel-stage:hover {
            box-shadow: 0 4px 8px rgba(45, 122, 122, 0.15);
            transform: translateY(-2px);
        }

        .funnel-stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .funnel-stage-name {
            font-weight: 700;
            font-size: 15px;
            color: #2d7a7a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .funnel-stage-stats {
            text-align: right;
        }

        .funnel-stage-value {
            font-size: 22px;
            font-weight: bold;
            color: #2d7a7a;
        }

        .funnel-stage-weighted {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .funnel-stage-conversion {
            font-size: 10px;
            color: #e07856;
            font-weight: 600;
            margin-top: 2px;
        }

        .funnel-bar {
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .funnel-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d7a7a 0%, #4a9999 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .funnel-stage-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .funnel-metric {
            text-align: center;
        }

        .funnel-metric-label {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .funnel-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .pipeline-forecast {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .forecast-month {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .forecast-month:last-child {
            border-bottom: none;
        }

        .forecast-month-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .forecast-month-name {
            font-weight: 600;
            color: #333;
        }

        .forecast-month-value {
            font-weight: bold;
            color: #2d7a7a;
        }

        .pipeline-deals-list {
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .pipeline-deal-card {
            padding: 18px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .pipeline-deal-card:hover {
            border-color: #2d7a7a;
            box-shadow: 0 4px 12px rgba(45, 122, 122, 0.2);
            transform: translateX(4px);
        }

        .pipeline-deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .pipeline-deal-name {
            font-weight: 700;
            font-size: 16px;
            color: #2d7a7a;
            flex: 1;
        }

        .pipeline-deal-value {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            margin-left: 15px;
        }

        .pipeline-deal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .pipeline-deal-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pipeline-deal-weighted {
            font-size: 11px;
            color: #e07856;
            font-weight: 600;
            margin-top: 8px;
            padding: 6px 10px;
            background: #fff8e1;
            border-radius: 4px;
            display: inline-block;
        }

        .pipeline-filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
        }

        .pipeline-totals {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .pipeline-total-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-top: 4px solid #2d7a7a;
        }

        .pipeline-total-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .pipeline-total-value {
            font-size: 28px;
            font-weight: bold;
            color: #2d7a7a;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="/assets/logo.png" alt="Midwest Natural Fiber" class="logo-img" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';">
                <div id="logoFallback" class="logo-fallback">
                    <div class="logo-text">MNF</div>
                    <div class="logo-subtext">MIDWEST NATURAL FIBER</div>
                </div>
            </div>
            <div>
                <h1>Midwest Natural Fiber CRM</h1>
                <p>Sales Pipeline & Opportunity Management</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('opportunities')">Opportunities</button>
            <button class="tab-btn" onclick="switchTab('pipeline')">Pipeline</button>
            <button class="tab-btn" onclick="switchTab('companies')">Companies</button>
            <button class="tab-btn" onclick="switchTab('contacts')">Contacts</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">
            <!-- Annual Goal Gauge -->
            <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 30px; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 20px; color: #2d7a7a;">Annual Sales Goal Progress</h2>
                    <button onclick="openGoalSettingsModal()" style="padding: 8px 15px; font-size: 12px;">⚙️ Edit Goal</button>
                </div>
                <div style="position: relative; width: 100%; max-width: 600px; margin: 0 auto;">
                    <svg id="goalGauge" width="100%" height="300" viewBox="0 0 400 220"></svg>
                    <div id="goalText" style="text-align: center; margin-top: 10px;"></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-label">Closed This Quarter</div>
                    <div class="metric-value" id="closedThisQuarter">$0</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">Realized Revenue</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">My Pipeline</div>
                    <div class="metric-value" id="myPipeline">$0</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">Total Open Opportunities</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">My Forecast</div>
                    <div class="metric-value" id="myForecast">$0</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">Weighted Forecast</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value" id="totalRevenue">$0</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">Closed Business All Time</div>
                </div>
            </div>

            <!-- Tasks This Week Widget -->
            <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; font-size: 18px; color: #2d7a7a;">Tasks This Week</h2>
                <div id="tasksThisWeek">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <h2 style="margin-bottom: 20px; font-size: 18px; color: #333;">My Top 10 Opportunities</h2>
            <table>
                <thead>
                    <tr>
                        <th>Opportunity Name</th>
                        <th>Stage</th>
                        <th>Amount</th>
                        <th>Probability</th>
                        <th>Expected Close</th>
                        <th>SKUs</th>
                    </tr>
                </thead>
                <tbody id="topOppsTable">
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <h3 style="margin-bottom: 15px; color: #2d7a7a;">Pipeline by Stage</h3>
                    <div id="pipelineByStage"></div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                    <h3 style="margin-bottom: 15px; color: #2d7a7a;">Forecast Summary</h3>
                    <div id="forecastSummary"></div>
                    <canvas id="forecastChart" style="margin-top: 15px;"></canvas>
                </div>
            </div>
        </div>

        <!-- OPPORTUNITIES TAB -->
        <div id="opportunities" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button onclick="openAddOppModal()">+ Add Opportunity</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Opportunity Name</th>
                        <th>Contact</th>
                        <th>Stage</th>
                        <th>Amount</th>
                        <th>Probability</th>
                        <th>Expected Close</th>
                        <th>SKUs</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="oppsTable">
                    <tr><td colspan="8" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Add/Edit Opportunity Modal - MOVED OUTSIDE TAB -->
        <div id="oppModal" class="modal">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeOppModal()">&times;</span>
                    <div class="modal-header">Add Opportunity</div>
                    
                    <div class="form-group">
                        <label>Opportunity Name *</label>
                        <input type="text" id="oppName" placeholder="Enter opportunity name">
                    </div>

                    <div class="form-group">
                        <label>Contact *</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="oppContact" style="flex: 1;">
                                <option value="">Select Contact</option>
                            </select>
                            <button onclick="openAddContactModal()" style="padding: 10px 15px;">+ Contact</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Amount *</label>
                        <input type="number" id="oppAmount" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label>Stage *</label>
                        <select id="oppStage">
                            <option value="">Select Stage</option>
                            <option value="qualification">Qualification</option>
                            <option value="needs_analysis">Needs Analysis</option>
                            <option value="proposal">Proposal/Quote</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="closed_won">Closed Won</option>
                            <option value="closed_lost">Closed Lost</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <select id="oppStatus">
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Probability (%)</label>
                        <input type="number" id="oppProbability" min="0" max="100" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>Expected Close Date</label>
                        <input type="date" id="oppCloseDate">
                    </div>

                    <div class="form-group" id="closedRevenueGroup" style="display: none;">
                        <label>Closed Revenue *</label>
                        <input type="number" id="oppClosedRevenue" placeholder="0.00" step="0.01">
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            Enter actual revenue received/invoiced (different from Deal Value if only partial revenue closed)
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Lead Source</label>
                        <input type="text" id="oppLeadSource" placeholder="How did you hear about this opportunity?">
                    </div>

                    <div class="form-group">
                        <label>Budget</label>
                        <input type="text" id="oppBudget" placeholder="e.g., $100k allocated">
                    </div>

                    <div class="form-group">
                        <label>Authority</label>
                        <input type="text" id="oppAuthority" placeholder="Who is the decision maker?">
                    </div>

                    <div class="form-group">
                        <label>Need</label>
                        <textarea id="oppNeed" placeholder="What are their needs?"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Timeline</label>
                        <input type="text" id="oppTimeline" placeholder="When do they need to decide?">
                    </div>

                    <!-- SKU Selection -->
                    <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                        <div style="font-weight: 600; margin-bottom: 15px; color: #2d7a7a;">Select SKUs</div>

                        <!-- Raw Materials - Fiber -->
                        <div class="sku-section">
                            <div class="sku-section-title">Fiber (Raw Materials)</div>
                            <div class="sku-options">
                                <div class="sku-checkbox">
                                    <input type="checkbox" id="sku-fiber-all" onchange="toggleCategory('fiber')">
                                    <label for="sku-fiber-all"><strong>All Fiber Grades</strong></label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku fiber" data-sku="1">
                                    <label>Fiber - Premium Clean Long Fiber</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku fiber" data-sku="2">
                                    <label>Fiber - Non-woven Grade, Clean Fiber</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku fiber" data-sku="3">
                                    <label>Fiber - Short Fiber/Hurd Mix</label>
                                </div>
                            </div>
                        </div>

                        <!-- Raw Materials - Hurd -->
                        <div class="sku-section">
                            <div class="sku-section-title">Hurd (Raw Materials)</div>
                            <div class="sku-options">
                                <div class="sku-checkbox">
                                    <input type="checkbox" id="sku-hurd-all" onchange="toggleCategory('hurd')">
                                    <label for="sku-hurd-all"><strong>All Hurd Sizes</strong></label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku hurd" data-sku="4">
                                    <label>Hurd - H1 (3/4")</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku hurd" data-sku="5">
                                    <label>Hurd - H2 (1/2")</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku hurd" data-sku="6">
                                    <label>Hurd - H3 (1/16")</label>
                                </div>
                            </div>
                        </div>

                        <!-- Products - Insulation -->
                        <div class="sku-section">
                            <div class="sku-section-title">Insulation (Products)</div>
                            <div class="sku-options">
                                <div class="sku-checkbox">
                                    <input type="checkbox" id="sku-insulation-all" onchange="toggleCategory('insulation')">
                                    <label for="sku-insulation-all"><strong>All Insulation Sizes</strong></label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku insulation" data-sku="7">
                                    <label>Insulation - 2"x24"x48"</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku insulation" data-sku="8">
                                    <label>Insulation - 3.5"x24"x48"</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku insulation" data-sku="9">
                                    <label>Insulation - 5.5"x24"x48"</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku insulation" data-sku="10">
                                    <label>Insulation - 7.5"x24"x48"</label>
                                </div>
                            </div>
                        </div>

                        <!-- Products - Acoustic Panels -->
                        <div class="sku-section">
                            <div class="sku-section-title">Acoustic Panels (Products)</div>
                            <div class="sku-options">
                                <div class="sku-checkbox">
                                    <input type="checkbox" id="sku-acoustic-all" onchange="toggleCategory('acoustic')">
                                    <label for="sku-acoustic-all"><strong>All Acoustic Panel Sizes</strong></label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku acoustic" data-sku="11">
                                    <label>Acoustic Panels - 1"x24"x48"</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku acoustic" data-sku="12">
                                    <label>Acoustic Panels - 2"x24"x48"</label>
                                </div>
                                <div class="sku-checkbox" style="margin-left: 20px;">
                                    <input type="checkbox" class="sku acoustic" data-sku="13">
                                    <label>Acoustic Panels - 4"x24"x48"</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveOpportunity()" style="width: 100%; padding: 12px; margin-top: 20px;">Save Opportunity</button>
                </div>
            </div>

        <!-- Opportunity Detail Modal - OUTSIDE TABS -->
        <div id="oppDetailModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeOppDetailModal()">&times;</span>
                <div class="modal-header" id="oppDetailTitle">Opportunity Details</div>
                
                <div id="oppDetailContent"></div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="openEditOppDetailModal()" style="flex: 1;">Edit Opportunity</button>
                    <button onclick="closeOppDetailModal()" style="flex: 1; background: #999;">Close</button>
                </div>
            </div>
        </div>

        <!-- PIPELINE TAB -->
        <div id="pipeline" class="tab-content">
            <h2 style="margin-bottom: 20px; color: #333;">Pipeline Overview</h2>

            <div class="pipeline-totals" id="pipelineTotals">
                <div class="pipeline-total-card">
                    <div class="pipeline-total-label">Total Pipeline</div>
                    <div class="pipeline-total-value" id="pipelineTotalValue">$0</div>
                </div>
                <div class="pipeline-total-card">
                    <div class="pipeline-total-label">Weighted Forecast</div>
                    <div class="pipeline-total-value" id="pipelineWeightedValue">$0</div>
                </div>
                <div class="pipeline-total-card">
                    <div class="pipeline-total-label">Open Deals</div>
                    <div class="pipeline-total-value" id="pipelineDealCount">0</div>
                </div>
            </div>

            <div class="pipeline-container">
                <div class="pipeline-funnel">
                    <h3 style="margin-bottom: 20px; color: #2d7a7a;">Pipeline by Stage</h3>
                    <div id="pipelineFunnel"></div>
                </div>
                <div class="pipeline-forecast">
                    <h3 style="margin-bottom: 20px; color: #2d7a7a;">Monthly Forecast</h3>
                    <div id="monthlyForecast"></div>
                </div>
            </div>

            <div class="pipeline-deals-list">
                <h3 style="margin-bottom: 20px; color: #2d7a7a;">All Open Opportunities</h3>

                <!-- Filters -->
                <div class="pipeline-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Filter by Stage</label>
                            <select id="pipelineStageFilter" onchange="filterPipelineDeals()">
                                <option value="">All Stages</option>
                                <option value="qualification">Qualification</option>
                                <option value="needs_analysis">Needs Analysis</option>
                                <option value="proposal">Proposal/Quote</option>
                                <option value="negotiation">Negotiation</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Sort By</label>
                            <select id="pipelineSortFilter" onchange="filterPipelineDeals()">
                                <option value="value_desc">Value (High to Low)</option>
                                <option value="value_asc">Value (Low to High)</option>
                                <option value="probability_desc">Probability (High to Low)</option>
                                <option value="probability_asc">Probability (Low to High)</option>
                                <option value="date_asc">Close Date (Earliest First)</option>
                                <option value="date_desc">Close Date (Latest First)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Minimum Value</label>
                            <select id="pipelineValueFilter" onchange="filterPipelineDeals()">
                                <option value="0">All Values</option>
                                <option value="10000">$10,000+</option>
                                <option value="25000">$25,000+</option>
                                <option value="50000">$50,000+</option>
                                <option value="100000">$100,000+</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="pipelineDeals"></div>
            </div>
        </div>

        <!-- Add Activity Modal - OUTSIDE TABS -->
        <div id="activityModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeActivityModal()">&times;</span>
                <div class="modal-header">Log Activity</div>
                
                <div class="form-group">
                    <label>Opportunity *</label>
                    <select id="activityDeal">
                        <option value="">Select Opportunity</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Activity Type *</label>
                    <select id="activityType">
                        <option value="">Select Type</option>
                        <option value="call">Phone Call</option>
                        <option value="email">Email</option>
                        <option value="meeting">Meeting</option>
                        <option value="proposal">Proposal Sent</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="activityDate">
                </div>

                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="activityDescription" placeholder="What happened?"></textarea>
                </div>

                <div class="form-group">
                    <label>Next Steps</label>
                    <textarea id="activityNextSteps" placeholder="What are the next steps for this opportunity?"></textarea>
                </div>

                <div class="form-group">
                    <label>Next Step Due Date</label>
                    <input type="date" id="activityDueDate">
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                        When should the next step be completed?
                    </div>
                </div>

                <button onclick="saveActivity()" style="width: 100%; padding: 12px;">Save Activity</button>
            </div>
        </div>

        <!-- COMPANIES TAB -->
        <div id="companies" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button onclick="openAddCompanyModal()">+ Add Company</button>
            </div>

            <div id="companiesList"></div>
        </div>

        <!-- CONTACTS TAB -->
        <div id="contacts" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button onclick="openAddContactModal()">+ Add Contact</button>
            </div>

            <div id="contactsList"></div>
        </div>
    </div>

    <!-- Add/Edit Contact Modal - OUTSIDE TABS AND CONTAINER -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeContactModal()">&times;</span>
            <div class="modal-header">Add Contact</div>
            
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="contactName" placeholder="Full name">
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="contactEmail" placeholder="email@example.com">
            </div>

            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="contactPhone" placeholder="(XXX)XXX-XXXX" onkeyup="handlePhoneInput(this)">
            </div>

            <div class="form-group">
                <label>Company</label>
                <select id="contactCompanyId">
                    <option value="">-- Select Company --</option>
                </select>
                <input type="text" id="contactCompany" placeholder="Or enter company name" style="margin-top: 8px;">
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    Select an existing company or enter a new company name
                </div>
            </div>

            <div class="form-group">
                <label>Job Title</label>
                <input type="text" id="contactTitle" placeholder="e.g., Purchasing Manager">
            </div>

            <div class="form-group">
                <label>Company Website</label>
                <input type="text" id="contactWebsite" placeholder="https://example.com">
            </div>

            <div class="form-group">
                <label>Additional Info</label>
                <textarea id="contactInfo" placeholder="Any other notes about this contact"></textarea>
            </div>

            <button onclick="saveContact()" style="width: 100%; padding: 12px;">Save Contact</button>
        </div>
    </div>

    <!-- Add/Edit Company Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCompanyModal()">&times;</span>
            <div class="modal-header">Add Company</div>

            <div class="form-group">
                <label>Company Name *</label>
                <input type="text" id="companyName" placeholder="Company name">
            </div>

            <div class="form-group">
                <label>Website</label>
                <input type="text" id="companyWebsite" placeholder="https://example.com">
            </div>

            <div class="form-group">
                <label>Industry</label>
                <input type="text" id="companyIndustry" placeholder="e.g., Manufacturing, Construction">
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="companyNotes" placeholder="Any notes about this company"></textarea>
            </div>

            <button onclick="saveCompany()" style="width: 100%; padding: 12px;">Save Company</button>
        </div>
    </div>

    <!-- Goal Settings Modal -->
    <div id="goalSettingsModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeGoalSettingsModal()">&times;</span>
            <div class="modal-header">Edit Annual Sales Goal</div>

            <div class="form-group">
                <label>Annual Goal Amount *</label>
                <input type="number" id="goalAmount" placeholder="1000000" step="1000">
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    Enter your annual sales target in dollars
                </div>
            </div>

            <button onclick="saveGoalSettings()" style="width: 100%; padding: 12px;">Save Goal</button>
        </div>
    </div>

    <script>
        // Auto-detect API URL based on current location
        const API_URL = window.location.origin + '/api';
        let currentEditingOppId = null;
        let currentEditingContactId = null;
        
        // Cache for deals data to avoid multiple API calls
        let cachedDeals = null;
        let dealsLastFetched = 0;
        const CACHE_DURATION = 5000; // 5 seconds

        // Initialize - load data sequentially to avoid database locks
        document.addEventListener('DOMContentLoaded', async () => {
            setActivityDateToToday();
            await loadAllData();
            await loadGoalProgress(); // Load goal gauge
            await loadTasksThisWeek(); // Load tasks widget
        });
        
        async function loadAllData() {
            try {
                // Load companies and contacts first
                await loadCompanies();
                await loadContacts();
                // Then load deals (this caches the data)
                await loadDealsData();
                // Then update UI with cached deals
                updateDashboardWithDeals();
                updateOpportunitiesTable();
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }
        
        async function loadDealsData(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && cachedDeals && (now - dealsLastFetched) < CACHE_DURATION) {
                return cachedDeals; // Return cached data
            }
            
            try {
                const response = await fetch(`${API_URL}/deals`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                cachedDeals = await response.json();
                dealsLastFetched = now;
                console.log('Deals loaded:', cachedDeals);
                return cachedDeals;
            } catch (err) {
                console.error('Error fetching deals:', err);
                return cachedDeals || []; // Return cached or empty array
            }
        }
        
        function updateDashboardWithDeals() {
            if (!cachedDeals) return;
            
            const deals = cachedDeals;
            const openDeals = deals.filter(d => d.status === 'open');
            const closedDeals = deals.filter(d => d.status === 'closed');
            
            // Update metrics
            const pipeline = openDeals.reduce((sum, d) => sum + (d.value || 0), 0);
            const realized = closedDeals.reduce((sum, d) => sum + (d.value || 0), 0);
            const forecasted = openDeals.reduce((sum, d) => sum + ((d.value || 0) * (d.probability || 0) / 100), 0);
            
            document.getElementById('closedThisQuarter').textContent = formatCurrency(realized);
            document.getElementById('myPipeline').textContent = formatCurrency(pipeline);
            document.getElementById('myForecast').textContent = formatCurrency(forecasted);
            document.getElementById('totalRevenue').textContent = formatCurrency(realized);
            
            // Update pipeline by stage
            const stages = {};
            const stageOrder = ['qualification', 'needs_analysis', 'proposal', 'negotiation'];
            stageOrder.forEach(stage => {
                stages[stage] = { count: 0, value: 0 };
            });
            openDeals.forEach(d => {
                if (stages[d.stage]) {
                    stages[d.stage].count++;
                    stages[d.stage].value += d.value || 0;
                }
            });
            const maxValue = Math.max(...Object.values(stages).map(s => s.value), 1);
            const pipelineHtml = stageOrder.map(stage => {
                const data = stages[stage];
                const width = (data.value / maxValue) * 100;
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #333;">${formatStageName(stage)}</span>
                            <span style="color: #666; font-size: 12px;">${data.count} deals | ${formatCurrency(data.value)}</span>
                        </div>
                        <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(to right, #2d7a7a, #4a9999); height: 100%; width: ${width}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('pipelineByStage').innerHTML = pipelineHtml || '<div class="empty-state">No open opportunities</div>';
            
            // Update forecast summary
            document.getElementById('forecastSummary').innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <span>Open Pipeline:</span>
                    <strong>${formatCurrency(pipeline)}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <span>Weighted Forecast:</span>
                    <strong>${formatCurrency(forecasted)}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 10px; background: #d4edda; border-radius: 4px;">
                    <span>Closed Revenue:</span>
                    <strong>${formatCurrency(realized)}</strong>
                </div>
            `;
            
            // Update forecast chart (safely)
            const ctx = document.getElementById('forecastChart');
            if (ctx) {
                // Safely destroy existing chart
                if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
                    window.forecastChart.destroy();
                    window.forecastChart = null;
                }
                
                if (pipeline > 0 || realized > 0) {
                    window.forecastChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Open Pipeline', 'Closed Revenue'],
                            datasets: [{
                                data: [pipeline, realized],
                                backgroundColor: ['#2d7a7a', '#1b6e0b']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { 
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
            }
            
            // Update Top 10 opportunities
            updateTopOpportunities();
        }
        
        function updateTopOpportunities() {
            if (!cachedDeals) return;
            const sortedDeals = [...cachedDeals].sort((a, b) => (b.value || 0) - (a.value || 0));
            const topOppsTable = document.getElementById('topOppsTable');
            
            topOppsTable.innerHTML = sortedDeals.slice(0, 10).map(d => `
                <tr class="clickable-row" onclick="openOppModal(${d.id})">
                    <td><span class="opp-link">${d.name || '(No Name)'}</span></td>
                    <td>${formatStageName(d.stage)}</td>
                    <td>${formatCurrency(d.value)}</td>
                    <td><span class="${getProbabilityColor(d.probability)}">${d.probability || 0}%</span></td>
                    <td>${formatDate(d.expected_close_date)}</td>
                    <td style="font-size: 11px;">${(d.skus || []).map(s => formatSkuDisplay(s)).join(', ')}</td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="empty-state">No opportunities yet</td></tr>';
        }
        
        function updateOpportunitiesTable() {
            if (!cachedDeals) return;
            const table = document.getElementById('oppsTable');
            
            table.innerHTML = cachedDeals.map(d => `
                <tr>
                    <td><span class="opp-link" onclick="openOppModal(${d.id})">${d.name || '(No Name)'}</span></td>
                    <td>${d.contact_name || ''}</td>
                    <td>${formatStageName(d.stage)}</td>
                    <td>${formatCurrency(d.value)}</td>
                    <td><span class="${getProbabilityColor(d.probability)}">${d.probability || 0}%</span></td>
                    <td>${formatDate(d.expected_close_date)}</td>
                    <td>${(d.skus || []).map(s => `<div style="font-size: 11px;">${formatSkuDisplay(s)}</div>`).join('')}</td>
                    <td><button onclick="deleteOpportunity(${d.id})">Delete</button></td>
                </tr>
            `).join('') || '<tr><td colspan="8" class="empty-state">No opportunities yet</td></tr>';
        }
        
        // Refresh all data (used after saves)
        async function refreshData() {
            await loadDealsData(true); // Force refresh
            updateDashboardWithDeals();
            updateOpportunitiesTable();
        }

        // Utility Functions
        function formatCurrency(val) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
        }

        function getProbabilityColor(prob) {
            if (prob <= 33) return 'prob-0-33';
            if (prob <= 66) return 'prob-34-66';
            return 'prob-67-100';
        }

        function formatPhoneNumber(value) {
            const cleaned = value.replace(/\D/g, '');
            if (cleaned.length <= 3) return cleaned;
            else if (cleaned.length <= 6) return `(${cleaned.slice(0, 3)})${cleaned.slice(3)}`;
            else return `(${cleaned.slice(0, 3)})${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
        }

        function handlePhoneInput(inputElement) {
            inputElement.value = formatPhoneNumber(inputElement.value);
        }

        function setActivityDateToToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('activityDate').value = today;
        }

        function formatStageName(stage) {
            const stageNames = {
                'qualification': 'Qualification',
                'needs_analysis': 'Needs Analysis',
                'proposal': 'Proposal/Quote',
                'negotiation': 'Negotiation',
                'closed_won': 'Closed Won',
                'closed_lost': 'Closed Lost'
            };
            return stageNames[stage] || stage;
        }

        function formatSkuDisplay(sku) {
            // Format: "Subcategory - Size/Name"
            return `${sku.subcategory} - ${sku.name}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Not set';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatMonthYear(monthKey) {
            if (monthKey === 'No Date Set') return monthKey;
            const [year, month] = monthKey.split('-');
            const date = new Date(year, parseInt(month) - 1);
            return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboardWithDeals(); // Use cached data
            } else if (tabName === 'pipeline') {
                loadPipelineAnalytics();
            } else if (tabName === 'companies') {
                loadCompanies();
            }
        }

        // GOAL PROGRESS GAUGE
        async function loadGoalProgress() {
            try {
                const response = await fetch(`${API_URL}/goal/progress`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                drawGoalGauge(data);
            } catch (err) {
                console.error('Error loading goal progress:', err);
            }
        }

        function drawGoalGauge(data) {
            const { annual_goal, closed_revenue, percentage } = data;
            const svg = document.getElementById('goalGauge');
            const centerX = 200;
            const centerY = 150;
            const radius = 120;

            // Clear existing SVG
            svg.innerHTML = '';

            // Calculate segment boundaries
            const third = annual_goal / 3;
            const twoThirds = (annual_goal * 2) / 3;

            // Draw the three colored segments (bottom semicircle, left to right)
            // Red segment (0 to 1/3) - LEFT SIDE
            drawArc(svg, centerX, centerY, radius, Math.PI, Math.PI * 1.333, '#ff4444', 20);
            // Yellow segment (1/3 to 2/3) - MIDDLE
            drawArc(svg, centerX, centerY, radius, Math.PI * 1.333, Math.PI * 1.667, '#ffaa00', 20);
            // Green segment (2/3 to 3/3) - RIGHT SIDE
            drawArc(svg, centerX, centerY, radius, Math.PI * 1.667, Math.PI * 2, '#44ff44', 20);

            // Add value labels at bottom
            addText(svg, 30, centerY + 25, '$0', '12px', '#666');
            addText(svg, 370, centerY + 25, formatCurrency(annual_goal), '12px', '#666', 'normal', 'end');

            // Add third markers (outside the arc)
            const labelRadius = radius + 35;
            const thirdAngle = Math.PI * 1.333;
            const thirdX = centerX + labelRadius * Math.cos(thirdAngle);
            const thirdY = centerY + labelRadius * Math.sin(thirdAngle);
            addText(svg, thirdX, thirdY, formatCurrency(third), '10px', '#666', 'normal', 'middle');

            const twoThirdsAngle = Math.PI * 1.667;
            const twoThirdsX = centerX + labelRadius * Math.cos(twoThirdsAngle);
            const twoThirdsY = centerY + labelRadius * Math.sin(twoThirdsAngle);
            addText(svg, twoThirdsX, twoThirdsY, formatCurrency(twoThirds), '10px', '#666', 'normal', 'middle');

            // Calculate needle angle based on percentage (from PI to 2*PI for bottom arc)
            const needlePercentage = Math.min(percentage, 100);
            const needleAngle = Math.PI + (needlePercentage / 100) * Math.PI;

            // Draw needle
            const needleLength = radius - 10;
            const needleX = centerX + needleLength * Math.cos(needleAngle);
            const needleY = centerY + needleLength * Math.sin(needleAngle);

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', centerX);
            line.setAttribute('y1', centerY);
            line.setAttribute('x2', needleX);
            line.setAttribute('y2', needleY);
            line.setAttribute('stroke', '#2d7a7a');
            line.setAttribute('stroke-width', '4');
            line.setAttribute('stroke-linecap', 'round');
            svg.appendChild(line);

            // Draw center circle
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', centerX);
            circle.setAttribute('cy', centerY);
            circle.setAttribute('r', '8');
            circle.setAttribute('fill', '#2d7a7a');
            svg.appendChild(circle);

            // Update text below gauge
            document.getElementById('goalText').innerHTML = `
                <div style="font-size: 24px; font-weight: bold; color: #2d7a7a; margin-bottom: 5px;">
                    ${formatCurrency(closed_revenue)}
                </div>
                <div style="font-size: 14px; color: #666;">
                    ${percentage.toFixed(1)}% of ${formatCurrency(annual_goal)} annual goal
                </div>
            `;
        }

        function drawArc(svg, cx, cy, radius, startAngle, endAngle, color, thickness) {
            const startX = cx + radius * Math.cos(startAngle);
            const startY = cy + radius * Math.sin(startAngle);
            const endX = cx + radius * Math.cos(endAngle);
            const endY = cy + radius * Math.sin(endAngle);

            const largeArcFlag = Math.abs(endAngle - startAngle) > Math.PI ? 1 : 0;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = [
                `M ${startX} ${startY}`,
                `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`
            ].join(' ');

            path.setAttribute('d', d);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', color);
            path.setAttribute('stroke-width', thickness);
            path.setAttribute('stroke-linecap', 'round');
            svg.appendChild(path);
        }

        function addText(svg, x, y, text, size, color, weight = 'normal', anchor = 'start') {
            const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textEl.setAttribute('x', x);
            textEl.setAttribute('y', y);
            textEl.setAttribute('fill', color);
            textEl.setAttribute('font-size', size);
            textEl.setAttribute('font-weight', weight);
            textEl.setAttribute('text-anchor', anchor);
            textEl.textContent = text;
            svg.appendChild(textEl);
        }

        // GOAL SETTINGS MODAL
        function openGoalSettingsModal() {
            fetch(`${API_URL}/settings/annual_goal`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('goalAmount').value = data.value;
                    document.getElementById('goalSettingsModal').classList.add('active');
                })
                .catch(err => {
                    console.error('Error loading goal:', err);
                    document.getElementById('goalAmount').value = '1000000';
                    document.getElementById('goalSettingsModal').classList.add('active');
                });
        }

        function closeGoalSettingsModal() {
            document.getElementById('goalSettingsModal').classList.remove('active');
        }

        function saveGoalSettings() {
            const goalAmount = document.getElementById('goalAmount').value;

            if (!goalAmount || goalAmount <= 0) {
                alert('Please enter a valid goal amount');
                return;
            }

            fetch(`${API_URL}/settings/annual_goal`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: goalAmount })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                closeGoalSettingsModal();
                loadGoalProgress(); // Refresh gauge
            })
            .catch(err => {
                console.error('Error saving goal:', err);
                alert('Error saving goal. Please try again.');
            });
        }

        // TASKS THIS WEEK WIDGET
        async function loadTasksThisWeek() {
            try {
                const response = await fetch(`${API_URL}/tasks/this-week`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const tasks = await response.json();
                displayTasksThisWeek(tasks);
            } catch (err) {
                console.error('Error loading tasks:', err);
                document.getElementById('tasksThisWeek').innerHTML = '<div style="color: #999;">No tasks this week</div>';
            }
        }

        function displayTasksThisWeek(tasks) {
            const container = document.getElementById('tasksThisWeek');

            if (tasks.length === 0) {
                container.innerHTML = '<div style="color: #999; font-size: 14px;">No tasks scheduled for this week</div>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const dueDate = new Date(task.due_date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const taskDate = new Date(dueDate);
                taskDate.setHours(0, 0, 0, 0);

                const isOverdue = taskDate < today;
                const isToday = taskDate.getTime() === today.getTime();

                let dateColor = '#666';
                let dateLabel = dueDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                if (isOverdue) {
                    dateColor = '#ff4444';
                    dateLabel = 'OVERDUE - ' + dateLabel;
                } else if (isToday) {
                    dateColor = '#ff9900';
                    dateLabel = 'TODAY';
                }

                return `
                    <div style="border-left: 3px solid ${isOverdue ? '#ff4444' : isToday ? '#ff9900' : '#2d7a7a'}; padding: 12px 15px; margin-bottom: 12px; background: ${isOverdue ? '#fff5f5' : isToday ? '#fff9f0' : '#f9f9f9'}; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div style="font-weight: 500; color: #333; font-size: 14px;">${task.next_steps || 'Follow up'}</div>
                            <div style="font-size: 12px; color: ${dateColor}; font-weight: 500; white-space: nowrap; margin-left: 15px;">${dateLabel}</div>
                        </div>
                        ${task.deal_name ? `<div style="font-size: 12px; color: #666; margin-bottom: 3px;">Deal: ${task.deal_name}</div>` : ''}
                        ${task.contact_name ? `<div style="font-size: 12px; color: #666;">Contact: ${task.contact_name}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleCategory(category) {
            const allCheckbox = document.getElementById(`sku-${category}-all`);
            const skuCheckboxes = document.querySelectorAll(`.sku.${category}`);
            
            skuCheckboxes.forEach(checkbox => {
                checkbox.checked = allCheckbox.checked;
            });
        }

        // CONTACTS
        // ========== COMPANIES FUNCTIONS ==========
        let currentEditingCompanyId = null;

        function loadCompanies() {
            return fetch(`${API_URL}/companies`)
                .then(r => r.json())
                .then(companies => {
                    const companiesList = document.getElementById('companiesList');
                    const companySelect = document.getElementById('contactCompanyId');

                    // Update company selector in contact modal
                    if (companySelect) {
                        companySelect.innerHTML = '<option value="">-- Select Company --</option>';
                        companies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.id;
                            option.text = company.name;
                            companySelect.appendChild(option);
                        });
                    }

                    // Display companies with expandable contact lists
                    if (companiesList) {
                        companiesList.innerHTML = companies.map(company => `
                            <div class="company-item" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;" onclick="toggleCompanyContacts(${company.id})">
                                        <div style="font-size: 18px; font-weight: 600; color: #2d7a7a; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                            <span id="company-arrow-${company.id}" style="transition: transform 0.2s;">▶</span>
                                            ${company.name}
                                        </div>
                                        <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                            ${company.contact_count || 0} contact${company.contact_count !== 1 ? 's' : ''}
                                            ${company.industry ? ' | ' + company.industry : ''}
                                        </div>
                                        ${company.website ? '<div style="font-size: 12px; color: #999; margin-top: 3px;">🌐 ' + company.website + '</div>' : ''}
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button onclick="event.stopPropagation(); openEditCompanyModal(${company.id})" style="padding: 8px 15px; font-size: 13px;">Edit</button>
                                        <button onclick="event.stopPropagation(); deleteCompany(${company.id})" style="padding: 8px 15px; font-size: 13px; background: #ff4444;">Delete</button>
                                    </div>
                                </div>
                                <div id="company-contacts-${company.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                    <div class="loading">Loading contacts...</div>
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(err => console.error('Error loading companies:', err));
        }

        function toggleCompanyContacts(companyId) {
            const contactsDiv = document.getElementById(`company-contacts-${companyId}`);
            const arrow = document.getElementById(`company-arrow-${companyId}`);

            if (contactsDiv.style.display === 'none') {
                // Load and show contacts
                contactsDiv.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';

                fetch(`${API_URL}/companies/${companyId}/contacts`)
                    .then(r => r.json())
                    .then(contacts => {
                        if (contacts.length === 0) {
                            contactsDiv.innerHTML = '<div style="color: #999; font-size: 13px; padding: 10px;">No contacts yet</div>';
                        } else {
                            contactsDiv.innerHTML = contacts.map(c => `
                                <div class="contact-item" onclick="openEditContactModal(${c.id})" style="margin-bottom: 10px; padding: 12px; background: #f9f9f9; border-radius: 6px; cursor: pointer;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${c.name}</div>
                                    <div style="font-size: 12px; color: #666;">${c.title || ''}</div>
                                    <div style="font-size: 12px; color: #999; margin-top: 3px;">
                                        ${c.email || ''} ${c.phone ? (c.email ? ' | ' : '') + c.phone : ''}
                                    </div>
                                </div>
                            `).join('');
                        }
                    })
                    .catch(err => {
                        console.error('Error loading company contacts:', err);
                        contactsDiv.innerHTML = '<div style="color: #ff4444; font-size: 13px;">Error loading contacts</div>';
                    });
            } else {
                // Hide contacts
                contactsDiv.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function openAddCompanyModal() {
            currentEditingCompanyId = null;
            document.getElementById('companyName').value = '';
            document.getElementById('companyWebsite').value = '';
            document.getElementById('companyIndustry').value = '';
            document.getElementById('companyNotes').value = '';
            document.querySelector('#companyModal .modal-header').textContent = 'Add Company';
            document.getElementById('companyModal').classList.add('active');
        }

        function openEditCompanyModal(companyId) {
            fetch(`${API_URL}/companies`)
                .then(r => r.json())
                .then(companies => {
                    const company = companies.find(c => c.id === companyId);
                    if (company) {
                        currentEditingCompanyId = companyId;
                        document.getElementById('companyName').value = company.name;
                        document.getElementById('companyWebsite').value = company.website || '';
                        document.getElementById('companyIndustry').value = company.industry || '';
                        document.getElementById('companyNotes').value = company.notes || '';
                        document.querySelector('#companyModal .modal-header').textContent = 'Edit Company';
                        document.getElementById('companyModal').classList.add('active');
                    }
                });
        }

        function closeCompanyModal() {
            document.getElementById('companyModal').classList.remove('active');
            currentEditingCompanyId = null;
        }

        function saveCompany() {
            const companyData = {
                name: document.getElementById('companyName').value,
                website: document.getElementById('companyWebsite').value,
                industry: document.getElementById('companyIndustry').value,
                notes: document.getElementById('companyNotes').value
            };

            if (!companyData.name) {
                alert('Please enter a company name');
                return;
            }

            const url = currentEditingCompanyId
                ? `${API_URL}/companies/${currentEditingCompanyId}`
                : `${API_URL}/companies`;

            const method = currentEditingCompanyId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(companyData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                closeCompanyModal();
                loadCompanies();
                loadContacts(); // Reload contacts to update company dropdown
            })
            .catch(err => {
                console.error('Error saving company:', err);
                alert('Error saving company. Please try again.');
            });
        }

        function deleteCompany(companyId) {
            if (!confirm('Are you sure you want to delete this company? Associated contacts will not be deleted.')) {
                return;
            }

            fetch(`${API_URL}/companies/${companyId}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(() => {
                    loadCompanies();
                    loadContacts(); // Reload contacts to update company dropdown
                })
                .catch(err => {
                    console.error('Error deleting company:', err);
                    alert('Error deleting company. Please try again.');
                });
        }

        // ========== CONTACTS FUNCTIONS ==========
        function loadContacts() {
            return fetch(`${API_URL}/contacts`)
                .then(r => r.json())
                .then(contacts => {
                    const contactsList = document.getElementById('contactsList');
                    const contactSelect = document.getElementById('oppContact');

                    contactSelect.innerHTML = '<option value="">Select Contact</option>';

                    // Display contacts list
                    contactsList.innerHTML = contacts.map(c => `
                        <div class="contact-item" onclick="openEditContactModal(${c.id})">
                            <div class="contact-name">${c.name}</div>
                            <div class="contact-info">${c.company_name || c.company || ''} ${c.title ? '| ' + c.title : ''}</div>
                            <div class="contact-info">${c.email || ''} ${c.phone || ''}</div>
                            ${c.website ? '<div class="contact-info">🌐 ' + c.website + '</div>' : ''}
                        </div>
                    `).join('');

                    // Group contacts by company for the dropdown
                    const contactsByCompany = {};
                    const contactsWithoutCompany = [];

                    contacts.forEach(c => {
                        const companyName = c.company_name || c.company;
                        if (companyName) {
                            if (!contactsByCompany[companyName]) {
                                contactsByCompany[companyName] = [];
                            }
                            contactsByCompany[companyName].push(c);
                        } else {
                            contactsWithoutCompany.push(c);
                        }
                    });

                    // Add contacts without company first
                    if (contactsWithoutCompany.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = '-- No Company --';
                        contactsWithoutCompany.forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.id;
                            option.text = c.name;
                            optgroup.appendChild(option);
                        });
                        contactSelect.appendChild(optgroup);
                    }

                    // Add contacts grouped by company
                    Object.keys(contactsByCompany).sort().forEach(companyName => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = companyName;
                        contactsByCompany[companyName].forEach(c => {
                            const option = document.createElement('option');
                            option.value = c.id;
                            option.text = c.name + (c.title ? ' (' + c.title + ')' : '');
                            optgroup.appendChild(option);
                        });
                        contactSelect.appendChild(optgroup);
                    });
                })
                .catch(err => console.error('Error loading contacts:', err));
        }

        function openAddContactModal() {
            currentEditingContactId = null;
            document.getElementById('contactName').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactCompanyId').value = '';
            document.getElementById('contactCompany').value = '';
            document.getElementById('contactTitle').value = '';
            document.getElementById('contactWebsite').value = '';
            document.getElementById('contactInfo').value = '';
            document.getElementById('contactModal').classList.add('active');
            if (document.getElementById('oppModal').classList.contains('active')) {
                document.getElementById('oppModal').style.pointerEvents = 'none';
            }
        }

        function openEditContactModal(contactId) {
            fetch(`${API_URL}/contacts`)
                .then(r => r.json())
                .then(contacts => {
                    const contact = contacts.find(c => c.id === contactId);
                    if (contact) {
                        currentEditingContactId = contactId;
                        document.getElementById('contactName').value = contact.name;
                        document.getElementById('contactEmail').value = contact.email || '';
                        document.getElementById('contactPhone').value = contact.phone || '';
                        document.getElementById('contactCompanyId').value = contact.company_id || '';
                        document.getElementById('contactCompany').value = contact.company || '';
                        document.getElementById('contactTitle').value = contact.title || '';
                        document.getElementById('contactWebsite').value = contact.website || '';
                        document.getElementById('contactInfo').value = contact.additional_info || '';
                        document.getElementById('contactModal').classList.add('active');
                    }
                });
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            currentEditingContactId = null; // Reset editing state
            if (document.getElementById('oppModal').classList.contains('active')) {
                document.getElementById('oppModal').style.pointerEvents = 'auto';
            }
            loadContacts();
        }

        function saveContact() {
            const companyId = document.getElementById('contactCompanyId').value;
            const contactData = {
                name: document.getElementById('contactName').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                company: document.getElementById('contactCompany').value,
                company_id: companyId ? parseInt(companyId) : null,
                title: document.getElementById('contactTitle').value,
                website: document.getElementById('contactWebsite').value,
                additional_info: document.getElementById('contactInfo').value
            };

            if (!contactData.name) {
                alert('Please enter a contact name');
                return;
            }

            const url = currentEditingContactId
                ? `${API_URL}/contacts/${currentEditingContactId}`
                : `${API_URL}/contacts`;

            const method = currentEditingContactId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(contactData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                closeContactModal();
                loadContacts();
            })
            .catch(err => {
                console.error('Error saving contact:', err);
                alert('Error saving contact. Please try again.');
            });
        }

        // OPPORTUNITIES - Old function removed, using updateOpportunitiesTable() instead

        function openAddOppModal() {
            currentEditingOppId = null;
            document.getElementById('oppName').value = '';
            document.getElementById('oppContact').value = '';
            document.getElementById('oppAmount').value = '';
            document.getElementById('oppStage').value = '';
            document.getElementById('oppStatus').value = 'open';
            document.getElementById('oppProbability').value = '';
            document.getElementById('oppCloseDate').value = '';
            document.getElementById('oppClosedRevenue').value = '';
            document.getElementById('oppLeadSource').value = '';
            document.getElementById('oppBudget').value = '';
            document.getElementById('oppAuthority').value = '';
            document.getElementById('oppNeed').value = '';
            document.getElementById('oppTimeline').value = '';

            // Clear all SKU selections
            document.querySelectorAll('input[type="checkbox"][class*="sku"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[id*="sku-"][id*="-all"]').forEach(cb => cb.checked = false);

            // Hide closed revenue field by default
            document.getElementById('closedRevenueGroup').style.display = 'none';

            document.getElementById('oppModal').classList.add('active');
        }

        // Show/hide closed revenue field based on stage
        document.addEventListener('DOMContentLoaded', () => {
            const stageSelect = document.getElementById('oppStage');
            if (stageSelect) {
                stageSelect.addEventListener('change', function() {
                    const closedRevenueGroup = document.getElementById('closedRevenueGroup');
                    if (this.value === 'closed_won') {
                        closedRevenueGroup.style.display = 'block';
                    } else {
                        closedRevenueGroup.style.display = 'none';
                    }
                });
            }
        });

        function openOppModal(oppId) {
            fetch(`${API_URL}/deals`)
                .then(r => r.json())
                .then(deals => {
                    const opp = deals.find(d => d.id === oppId);
                    if (opp) {
                        openOppDetailModal(opp);
                    }
                });
        }

        function openOppDetailModal(opp) {
            const skuNames = (opp.skus || []).map(s => `<span class="sku-tag">${formatSkuDisplay(s)}</span>`).join('');
            
            const html = `
                <div class="detail-item">
                    <div class="detail-label">Contact</div>
                    <div class="detail-value">${opp.contact_name || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value">${formatCurrency(opp.value)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Stage</div>
                    <div class="detail-value">${formatStageName(opp.stage)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Probability</div>
                    <div class="detail-value"><span class="${getProbabilityColor(opp.probability)}">${opp.probability || 0}%</span></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Expected Close Date</div>
                    <div class="detail-value">${formatDate(opp.expected_close_date)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">SKUs</div>
                    <div class="detail-value">${skuNames || 'None selected'}</div>
                </div>
                <div class="bant-section">
                    <div class="bant-title">BANT Qualification</div>
                    <div class="detail-item" style="border-left: none; background: transparent;">
                        <div class="detail-label">Budget</div>
                        <div class="detail-value">${opp.budget || 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="border-left: none; background: transparent;">
                        <div class="detail-label">Authority</div>
                        <div class="detail-value">${opp.authority || 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="border-left: none; background: transparent;">
                        <div class="detail-label">Need</div>
                        <div class="detail-value">${opp.need || 'N/A'}</div>
                    </div>
                    <div class="detail-item" style="border-left: none; background: transparent;">
                        <div class="detail-label">Timeline</div>
                        <div class="detail-value">${opp.timeline || 'N/A'}</div>
                    </div>
                </div>
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #2d7a7a;">Next Steps</h4>
                <div id="oppNextSteps" style="background: #e8f4f4; padding: 15px; border-radius: 4px; margin-bottom: 15px;"></div>
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #2d7a7a;">Activities</h4>

                <!-- Inline Activity Form -->
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                    <h5 style="margin: 0 0 15px 0; color: #2d7a7a;">Log New Activity</h5>
                    <div style="display: grid; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">Activity Type *</label>
                            <select id="inlineActivityType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Select Type</option>
                                <option value="Call">Call</option>
                                <option value="Email">Email</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Note">Note</option>
                                <option value="Site Visit">Site Visit</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">Activity Date *</label>
                            <input type="date" id="inlineActivityDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">Description</label>
                            <textarea id="inlineActivityDescription" placeholder="What happened during this activity?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">Next Steps</label>
                            <textarea id="inlineActivityNextSteps" placeholder="What needs to happen next?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px;"></textarea>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">Next Step Due Date</label>
                            <input type="date" id="inlineActivityDueDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="saveInlineActivity(${opp.id})" style="padding: 10px 20px; background: #2d7a7a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            Save Activity
                        </button>
                    </div>
                </div>

                <div id="oppActivitiesList"></div>
            `;
            
            document.getElementById('oppDetailTitle').textContent = opp.name || '(No Name)';
            document.getElementById('oppDetailContent').innerHTML = html;
            document.getElementById('oppDetailModal').currentOppId = opp.id;

            // Set activity date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inlineActivityDate').value = today;
            
            // Load activities for this opp
            fetch(`${API_URL}/activities?deal_id=${opp.id}`)
                .then(r => r.json())
                .then(activities => {
                    const activitiesDiv = document.getElementById('oppActivitiesList');
                    const nextStepsDiv = document.getElementById('oppNextSteps');
                    
                    // Get the most recent next steps
                    const latestWithNextSteps = activities.find(a => a.next_steps);
                    nextStepsDiv.innerHTML = latestWithNextSteps 
                        ? `<div style="font-style: italic; color: #333;">${latestWithNextSteps.next_steps}</div>`
                        : '<div style="color: #999;">No next steps defined yet</div>';
                    
                    activitiesDiv.innerHTML = activities.map(a => `
                        <div class="activity-item">
                            <div class="activity-header">
                                <span class="activity-type">${a.type}</span>
                                <span class="activity-date">${new Date(a.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="activity-desc">${a.description}</div>
                            ${a.next_steps ? `
                                <div class="next-steps-label">Next Steps:</div>
                                <div class="next-steps-text">${a.next_steps}</div>
                            ` : ''}
                        </div>
                    `).join('') || '<div class="empty-state">No activities yet</div>';
                });
            
            document.getElementById('oppDetailModal').classList.add('active');
        }

        function openEditOppDetailModal() {
            const oppId = document.getElementById('oppDetailModal').currentOppId;
            fetch(`${API_URL}/deals`)
                .then(r => r.json())
                .then(deals => {
                    const opp = deals.find(d => d.id === oppId);
                    if (opp) {
                        currentEditingOppId = oppId;
                        document.getElementById('oppName').value = opp.name;
                        document.getElementById('oppContact').value = opp.contact_id || '';
                        document.getElementById('oppAmount').value = opp.value;
                        document.getElementById('oppStage').value = opp.stage;
                        document.getElementById('oppStatus').value = opp.status;
                        document.getElementById('oppProbability').value = opp.probability;
                        document.getElementById('oppCloseDate').value = opp.expected_close_date || '';
                        document.getElementById('oppLeadSource').value = opp.lead_source || '';
                        document.getElementById('oppBudget').value = opp.budget || '';
                        document.getElementById('oppAuthority').value = opp.authority || '';
                        document.getElementById('oppNeed').value = opp.need || '';
                        document.getElementById('oppTimeline').value = opp.timeline || '';
                        document.getElementById('oppClosedRevenue').value = opp.closed_revenue || '';

                        // Show/hide closed revenue field based on stage
                        const closedRevenueGroup = document.getElementById('closedRevenueGroup');
                        if (opp.stage === 'closed_won') {
                            closedRevenueGroup.style.display = 'block';
                        } else {
                            closedRevenueGroup.style.display = 'none';
                        }

                        // Clear and check SKUs
                        document.querySelectorAll('input[type="checkbox"][class*="sku"]').forEach(cb => cb.checked = false);
                        document.querySelectorAll('input[id*="sku-"][id*="-all"]').forEach(cb => cb.checked = false);

                        opp.skus.forEach(sku => {
                            const checkbox = document.querySelector(`input[data-sku="${sku.id}"]`);
                            if (checkbox) checkbox.checked = true;
                        });

                        closeOppDetailModal();
                        document.getElementById('oppModal').classList.add('active');
                    }
                });
        }

        function openAddActivityFromOpp(oppId) {
            document.getElementById('activityDeal').value = oppId;
            document.getElementById('activityType').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityNextSteps').value = '';
            setActivityDateToToday();
            document.getElementById('activityModal').classList.add('active');
        }

        function closeOppDetailModal() {
            document.getElementById('oppDetailModal').classList.remove('active');
        }

        function closeOppModal() {
            document.getElementById('oppModal').classList.remove('active');
            currentEditingOppId = null; // Reset editing state
        }

        function saveOpportunity() {
            // Validation
            const name = document.getElementById('oppName').value;
            const stage = document.getElementById('oppStage').value;

            if (!name) {
                alert('Please enter an opportunity name');
                return;
            }

            if (!stage) {
                alert('Please select a stage');
                return;
            }

            const selectedSkus = [];
            document.querySelectorAll('input[type="checkbox"][class*="sku"]:checked').forEach(cb => {
                if (cb.dataset.sku) {
                    selectedSkus.push(parseInt(cb.dataset.sku));
                }
            });

            const oppData = {
                name: name,
                contact_id: document.getElementById('oppContact').value || null,
                value: parseFloat(document.getElementById('oppAmount').value) || 0,
                probability: parseInt(document.getElementById('oppProbability').value) || 0,
                stage: stage,
                status: document.getElementById('oppStatus').value,
                expected_close_date: document.getElementById('oppCloseDate').value || null,
                closed_revenue: parseFloat(document.getElementById('oppClosedRevenue').value) || 0,
                lead_source: document.getElementById('oppLeadSource').value,
                budget: document.getElementById('oppBudget').value,
                authority: document.getElementById('oppAuthority').value,
                need: document.getElementById('oppNeed').value,
                timeline: document.getElementById('oppTimeline').value,
                sku_ids: selectedSkus
            };

            console.log('Saving opportunity:', oppData);
            console.log('currentEditingOppId:', currentEditingOppId);

            const url = currentEditingOppId
                ? `${API_URL}/deals/${currentEditingOppId}`
                : `${API_URL}/deals`;

            const method = currentEditingOppId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(oppData)
            })
            .then(response => {
                console.log('Save response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Save successful:', data);
                closeOppModal();
                refreshData(); // Use single refresh instead of multiple calls
            })
            .catch(err => {
                console.error('Error saving opportunity:', err);
                alert('Error saving opportunity. Check console for details.');
            });
        }

        function deleteOpportunity(oppId) {
            if (confirm('Delete this opportunity?')) {
                fetch(`${API_URL}/deals/${oppId}`, { method: 'DELETE' })
                    .then(() => {
                        refreshData(); // Use single refresh instead of multiple calls
                    });
            }
        }

        // ACTIVITIES
        function loadActivities() {
            return fetch(`${API_URL}/activities`)
                .then(r => r.json())
                .then(activities => {
                    const list = document.getElementById('activitiesList');
                    list.innerHTML = activities.map(a => `
                        <div class="activity-item">
                            <div class="activity-header">
                                <span class="activity-type">${a.type}</span>
                                <span class="activity-date">${new Date(a.created_at).toLocaleDateString()}</span>
                            </div>
                            <div class="activity-desc">${a.description}</div>
                            ${a.next_steps ? `
                                <div class="next-steps-label">Next Steps:</div>
                                <div class="next-steps-text">${a.next_steps}</div>
                            ` : ''}
                        </div>
                    `).join('') || '<div class="empty-state">No activities yet</div>';
                    
                    // Populate deal dropdown using cached deals
                    const deals = cachedDeals || [];
                    const select = document.getElementById('activityDeal');
                    select.innerHTML = '<option value="">Select Opportunity</option>' +
                        deals.map(d => `<option value="${d.id}">${d.name || '(No Name)'}</option>`).join('');
                })
                .catch(err => console.error('Error loading activities:', err));
        }

        function openAddActivityModal() {
            document.getElementById('activityDeal').value = '';
            document.getElementById('activityType').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityNextSteps').value = '';
            setActivityDateToToday();
            document.getElementById('activityModal').classList.add('active');
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
            // Refresh activity list if we're on the activity tab
            if (document.getElementById('activities').classList.contains('active')) {
                loadActivities();
            }
        }

        function saveActivity() {
            const activityData = {
                deal_id: document.getElementById('activityDeal').value || null,
                type: document.getElementById('activityType').value,
                description: `[${document.getElementById('activityDate').value}] ${document.getElementById('activityDescription').value}`,
                next_steps: document.getElementById('activityNextSteps').value || null,
                due_date: document.getElementById('activityDueDate').value || null
            };

            fetch(`${API_URL}/activities`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                closeActivityModal();
                loadActivities();
                // If in opportunity detail modal, refresh it too
                if (document.getElementById('oppDetailModal').classList.contains('active')) {
                    const oppId = document.getElementById('oppDetailModal').currentOppId;
                    if (oppId) {
                        openOppModal(oppId);
                    }
                }
            })
            .catch(err => {
                console.error('Error saving activity:', err);
                alert('Error saving activity. Please try again.');
            });
        }

        function saveInlineActivity(oppId) {
            const type = document.getElementById('inlineActivityType').value;
            const date = document.getElementById('inlineActivityDate').value;
            const description = document.getElementById('inlineActivityDescription').value;

            if (!type) {
                alert('Please select an activity type');
                return;
            }

            if (!date) {
                alert('Please select an activity date');
                return;
            }

            const activityData = {
                deal_id: oppId,
                type: type,
                description: `[${date}] ${description}`,
                next_steps: document.getElementById('inlineActivityNextSteps').value || null,
                due_date: document.getElementById('inlineActivityDueDate').value || null
            };

            fetch(`${API_URL}/activities`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(() => {
                // Clear the form
                document.getElementById('inlineActivityType').value = '';
                document.getElementById('inlineActivityDate').value = '';
                document.getElementById('inlineActivityDescription').value = '';
                document.getElementById('inlineActivityNextSteps').value = '';
                document.getElementById('inlineActivityDueDate').value = '';

                // Set date to today for next activity
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inlineActivityDate').value = today;

                // Reload the opportunity detail modal to show new activity
                openOppModal(oppId);
            })
            .catch(err => {
                console.error('Error saving activity:', err);
                alert('Error saving activity. Please try again.');
            });
        }

        // METRICS & CHARTS - Old functions removed, using updateDashboardWithDeals() instead

        // Store pipeline data globally for filtering
        let pipelineData = null;

        // PIPELINE FUNNEL VISUALIZATION
        function getStageFunnelColor(stage) {
            const colors = {
                'qualification': '#ff5555',      // Red
                'needs_analysis': '#ff9944',     // Red-orange
                'proposal': '#ffcc44',           // Yellow-orange
                'negotiation': '#66cc66'         // Green
            };
            return colors[stage] || '#666';
        }

        function drawPipelineFunnel(stages, stageOrder) {
            const svg = document.getElementById('funnelSVG');
            if (!svg) return;

            svg.innerHTML = ''; // Clear existing

            const width = 400;
            const height = 400;
            const funnelWidth = 320;
            const funnelStartX = (width - funnelWidth) / 2;
            const stageHeight = 80;
            const spacing = 10;

            stageOrder.forEach((stage, index) => {
                const stageData = stages[stage] || { total_value: 0, count: 0 };

                // Calculate trapezoid widths (narrowing from top to bottom)
                const topWidth = funnelWidth - (index * 60);
                const bottomWidth = funnelWidth - ((index + 1) * 60);
                const yPos = index * (stageHeight + spacing);

                // Center the trapezoid
                const topX = funnelStartX + (funnelWidth - topWidth) / 2;
                const bottomX = funnelStartX + (funnelWidth - bottomWidth) / 2;

                // Draw trapezoid
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `
                    M ${topX} ${yPos}
                    L ${topX + topWidth} ${yPos}
                    L ${bottomX + bottomWidth} ${yPos + stageHeight}
                    L ${bottomX} ${yPos + stageHeight}
                    Z
                `;
                path.setAttribute('d', d);
                path.setAttribute('fill', getStageFunnelColor(stage));
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('opacity', '0.9');
                svg.appendChild(path);

                // Add stage name
                const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                nameText.setAttribute('x', width / 2);
                nameText.setAttribute('y', yPos + 30);
                nameText.setAttribute('text-anchor', 'middle');
                nameText.setAttribute('fill', '#fff');
                nameText.setAttribute('font-size', '16');
                nameText.setAttribute('font-weight', 'bold');
                nameText.textContent = formatStageName(stage);
                svg.appendChild(nameText);

                // Add deal count
                const countText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                countText.setAttribute('x', width / 2);
                countText.setAttribute('y', yPos + 50);
                countText.setAttribute('text-anchor', 'middle');
                countText.setAttribute('fill', '#fff');
                countText.setAttribute('font-size', '14');
                countText.textContent = `${stageData.count} deals`;
                svg.appendChild(countText);

                // Add dollar amount
                const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valueText.setAttribute('x', width / 2);
                valueText.setAttribute('y', yPos + 68);
                valueText.setAttribute('text-anchor', 'middle');
                valueText.setAttribute('fill', '#fff');
                valueText.setAttribute('font-size', '13');
                valueText.textContent = formatCurrency(stageData.total_value);
                svg.appendChild(valueText);
            });
        }

        // PIPELINE ANALYTICS
        function loadPipelineAnalytics() {
            fetch(`${API_URL}/pipeline/analytics`)
                .then(r => r.json())
                .then(data => {
                    pipelineData = data; // Store for filtering

                    // Update totals
                    document.getElementById('pipelineTotalValue').textContent = formatCurrency(data.totals.pipeline);
                    document.getElementById('pipelineWeightedValue').textContent = formatCurrency(data.totals.weighted);
                    document.getElementById('pipelineDealCount').textContent = data.totals.deal_count;

                    // Render funnel by stage with SVG visualization
                    const stageOrder = ['qualification', 'needs_analysis', 'proposal', 'negotiation'];
                    drawPipelineFunnel(data.stages, stageOrder);

                    // Also show detailed metrics below funnel
                    const totalDeals = data.totals.deal_count;
                    const metricsHtml = stageOrder.map((stage, index) => {
                        const stageData = data.stages[stage] || { total_value: 0, weighted_value: 0, count: 0 };
                        const avgDealSize = stageData.count > 0 ? stageData.total_value / stageData.count : 0;
                        const avgProbability = stageData.count > 0 ? stageData.weighted_value / stageData.total_value * 100 : 0;
                        const stagePercent = totalDeals > 0 ? (stageData.count / totalDeals * 100).toFixed(0) : 0;

                        return `
                            <div style="padding: 12px; border-left: 3px solid ${getStageFunnelColor(stage)}; background: #f9f9f9; margin-bottom: 8px; border-radius: 4px;">
                                <div style="font-weight: 500; color: #333; margin-bottom: 5px;">${formatStageName(stage)}</div>
                                <div style="font-size: 12px; color: #666; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                    <div>Deals: <strong>${stageData.count}</strong> (${stagePercent}%)</div>
                                    <div>Avg Size: <strong>${formatCurrency(avgDealSize)}</strong></div>
                                    <div>Avg Prob: <strong>${avgProbability.toFixed(0)}%</strong></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('pipelineFunnel').innerHTML = `
                        <svg id="funnelSVG" width="100%" height="400" viewBox="0 0 400 400"></svg>
                        <div style="margin-top: 20px;">
                            ${metricsHtml}
                        </div>
                    ` || '<div class="empty-state">No open opportunities</div>';

                    // Render monthly forecast
                    const sortedMonths = Object.keys(data.monthly_forecast).sort();
                    const monthlyHtml = sortedMonths.map(month => {
                        const monthData = data.monthly_forecast[month];
                        return `
                            <div class="forecast-month">
                                <div class="forecast-month-header">
                                    <span class="forecast-month-name">${formatMonthYear(month)}</span>
                                    <span class="forecast-month-value">${formatCurrency(monthData.total)}</span>
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ${monthData.count} deals | Weighted: ${formatCurrency(monthData.weighted)}
                                </div>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('monthlyForecast').innerHTML = monthlyHtml || '<div class="empty-state">No expected close dates set</div>';

                    // Initial render of deals
                    filterPipelineDeals();
                })
                .catch(err => {
                    console.error('Error loading pipeline analytics:', err);
                });
        }

        function filterPipelineDeals() {
            if (!pipelineData) return;

            const stageFilter = document.getElementById('pipelineStageFilter').value;
            const sortFilter = document.getElementById('pipelineSortFilter').value;
            const valueFilter = parseFloat(document.getElementById('pipelineValueFilter').value);

            // Collect all deals
            const stageOrder = ['qualification', 'needs_analysis', 'proposal', 'negotiation'];
            let allDeals = [];
            stageOrder.forEach(stage => {
                if (pipelineData.stages[stage]) {
                    allDeals.push(...pipelineData.stages[stage].deals);
                }
            });

            // Apply filters
            let filteredDeals = allDeals.filter(deal => {
                // Stage filter
                if (stageFilter && deal.stage !== stageFilter) return false;

                // Value filter
                if (valueFilter > 0 && (deal.value || 0) < valueFilter) return false;

                return true;
            });

            // Apply sorting
            filteredDeals.sort((a, b) => {
                switch(sortFilter) {
                    case 'value_desc':
                        return (b.value || 0) - (a.value || 0);
                    case 'value_asc':
                        return (a.value || 0) - (b.value || 0);
                    case 'probability_desc':
                        return (b.probability || 0) - (a.probability || 0);
                    case 'probability_asc':
                        return (a.probability || 0) - (b.probability || 0);
                    case 'date_asc':
                        if (!a.expected_close_date) return 1;
                        if (!b.expected_close_date) return -1;
                        return a.expected_close_date.localeCompare(b.expected_close_date);
                    case 'date_desc':
                        if (!a.expected_close_date) return 1;
                        if (!b.expected_close_date) return -1;
                        return b.expected_close_date.localeCompare(a.expected_close_date);
                    default:
                        return (b.value || 0) - (a.value || 0);
                }
            });

            // Render deal cards with enhanced details
            const dealsHtml = filteredDeals.map(deal => {
                const weightedValue = (deal.value || 0) * (deal.probability || 0) / 100;
                return `
                    <div class="pipeline-deal-card" onclick="openOppModal(${deal.id})">
                        <div class="pipeline-deal-header">
                            <span class="pipeline-deal-name">${deal.name}</span>
                            <span class="pipeline-deal-value">${formatCurrency(deal.value)}</span>
                        </div>
                        <div class="pipeline-deal-meta">
                            <span class="pipeline-deal-meta-item">📊 ${formatStageName(deal.stage)}</span>
                            <span class="pipeline-deal-meta-item">🎯 <span class="${getProbabilityColor(deal.probability)}">${deal.probability || 0}%</span></span>
                            <span class="pipeline-deal-meta-item">📅 ${formatDate(deal.expected_close_date)}</span>
                            ${deal.contact_name ? `<span class="pipeline-deal-meta-item">👤 ${deal.contact_name}</span>` : ''}
                        </div>
                        ${deal.skus && deal.skus.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${deal.skus.map(s => `<span class="sku-tag">${formatSkuDisplay(s)}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="pipeline-deal-weighted">
                            Weighted Value: ${formatCurrency(weightedValue)}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('pipelineDeals').innerHTML = dealsHtml || '<div class="empty-state">No opportunities match your filters</div>';
        }
    </script>
</body>
</html>